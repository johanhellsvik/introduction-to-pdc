\section{Running jobs}
\frame{
\frametitle{How to run programs}
\begin{itemize}

  \item On login node you
  \begin{itemize}
    \item can submit jobs, edit files, compile small programs, or do other computationally light tasks.
    \item \alert{should not run calculations}.
  \end{itemize}

  \item To run your job, you need to 
  \begin{itemize}
      \item request compute node(s) using sbatch or salloc
      \item run your job using srun
  \end{itemize}

  \item The queueing/batch system
  \begin{itemize}
      \item All jobs must be connected to a time allocation.
      \item Courses also need time allocation. In addition, PDC can set up \textit{reservation} for resources (if necessary).
  \end{itemize}

  \end{itemize}
 }


\subsection{SLURM}

\frame{
\frametitle{SLURM workload manager}
\framesubtitle{Simple Linux Utility for Resource Management}
\begin{itemize}
 \item Open source, fault-tolerant, and highly scalable cluster management and job scheduling system
 \begin{itemize}
  \item Allocates access to resources
  \item Provides framework monitoring work on allocated nodes
  \item Arbitrates contention for resources
 \end{itemize}
 \item Job Priority computed based on 
 \begin{description}
    \item [Age] the length of time a job has been waiting
    \item [Fair-share] the difference between the promised computing resource and the consumed computing resource
    \item [Job size] the number of nodes or CPUs a job is allocated
    \item [Partition] a factor associated with each node partition
%    \item [QOS] a factor associated with each Quality Of Service
 \end{description}
\hfill \break
\scriptsize
\href{https://www.pdc.kth.se/support/documents/run\_jobs/job\_scheduling.html}{https://www.pdc.kth.se/support/documents/run\_jobs/job\_scheduling.html}
\end{itemize}
}


\frame{
\frametitle{SLURM workload manager}
\framesubtitle{Partitions}
\begin{itemize}
    \item Four partitions on Dardel
\end{itemize}
\begin{description}
   \item [main] Thin nodes (256 GB RAM), whole nodes, maximum 24 hours
   \item [long] Thin nodes (256 GB RAM), whole nodes, maximum 7 days
   \item [shared] Thin nodes (256 GB RAM), job shares nodes with other jobs, maximum 24 hours
   \item [memory] Large/Huge/Giant compute nodes (512 GB - 2 TB RAM), whole nodes, maximum 24 hours
\end{description}
}

\subsection*{SLURM commands}

\begin{frame}[fragile]
\frametitle{Interactive session \hfill \alert{\textbf{salloc}}}

\begin{exampleblock}{Request an interactive allocation of resources}
  \footnotesize
  \begin{verbatim}
  $ salloc -A <allocation> -t <d-hh:mm:ss> -p <partition> -N <nodes>
  salloc: Granted job allocation 123456
  \end{verbatim}
\end{exampleblock}

\begin{exampleblock}{Run application on compute nodes}
  \footnotesize
  \begin{verbatim}
  $ srun -n <number-of-MPI-processes> ./binary.x
  \end{verbatim}
\end{exampleblock}

\begin{exampleblock}{Log in to compute nodes - from login node (later also external login)}
  \footnotesize
  \begin{verbatim}
  $ ssh <user name>@<node name>
  \end{verbatim}
\end{exampleblock}
  
\end{frame}

\begin{frame}[fragile]
\frametitle{Launch batch jobs \hfill  \alert{\textbf{sbatch}}}
\begin{exampleblock}{Submit the job to SLURM queue}
\footnotesize
\begin{verbatim}
$ sbatch <script>
Submitted batch job 123456
\end{verbatim}
\end{exampleblock}

\begin{exampleblock}{Example script to run myexe for 1 hour on 2 nodes}
\footnotesize
\begin{verbatim}
#!/bin/bash

#SBATCH -A 20XX-X-XX
#SBATCH -J myjob
#SBATCH -t 01:00:00
#SBATCH -p main
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=128

srun ./myexe > my_output_file
\end{verbatim}
\end{exampleblock}

\scriptsize
\href{https://www.pdc.kth.se/support/documents/run\_jobs/job\_scripts.html}{https://www.pdc.kth.se/support/documents/run\_jobs/job\_scripts.html}
\end{frame}

\begin{frame}[fragile]
\frametitle{Monitoring and/or cancelling running jobs }
\begin{alertblock}{\textbf{squeue} -u  \$USER}
  Displays all queue and/or running jobs that belong to the user
\tiny
  \begin{verbatim}
user@dardel$ squeue -u user
 JOBID     USER ACCOUNT           NAME  ST REASON    START_TIME                TIME  TIME_LEFT NODES
 63519   user 20XX-X-XX      test-run1   R None      2021-11-15T08:15:24    6:09:42   17:49:18     2
 63757   user 20XX-X-XX      test-run2   R None      2021-11-15T11:14:20    3:10:46   20:48:14     8
  \end{verbatim}
\end{alertblock}

\begin{alertblock}{\textbf{scancel} [job]}
Stops a running job or removes a pending one from the queue
\tiny
  \begin{verbatim}
user@dardel$ scancel 63519
salloc: Job allocation 63519 has been revoked.

user@dardel$ squeue -u user
 JOBID     USER ACCOUNT           NAME  ST REASON    START_TIME                TIME  TIME_LEFT NODES
 63757   user 20XX-X-XX      test-run2   R None      2021-11-15T11:14:20    3:10:46   20:48:14     8
  \end{verbatim}
\end{alertblock}
\end{frame}
